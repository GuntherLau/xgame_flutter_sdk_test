import{r as i,j as e,T as r,H as x,R as P,b as K,h as H,aG as L,b9 as M,q as B,G as U,v as k,ba as W,bc as Y,bb as z}from"./index.sdk-0.0.1.js";import{A as G}from"./button.js";import{N as V}from"./normal-layout.js";import{A as C,O as T}from"./auth.dto.js";import{e as R}from"./common.js";import{a as $}from"./sucess-view.js";import"./main-layout.js";import"./popover.js";import"./Modal.js";import"./lazy-load-component.js";const J={email:"",otp:"",errors:{email:"",otp:""}},Q=(t,m)=>{switch(m.type){case"change":return t.errors[m.field]="",{...t,[m.field]:m.value};default:return t}};function ce(){const[t,m]=i.useState(!1),[w,v]=i.useState(!1),[s,a]=i.useReducer(Q,J),[O,A]=i.useState(!1),[_,f]=i.useState(0),[g,h]=i.useState(!1),E=i.useRef(null),S=d=>{const{name:p,value:o}=d.target;v(!1),a({type:"change",field:p,value:o})},j=()=>{s.errors={email:"",otp:""},R.test(s.email)||(s.errors.email=r.email_is_invalid()),s.otp||(s.errors.otp=r.otp_is_required());const d=!Object.values(s.errors).some(p=>p!="");return A(d),d},b=async()=>{var d,p;if(!j()){v(!0);return}m(!0);try{await M({newEmail:s.email,oldEmail:"",newOtp:s.otp,oldOtp:""}),h(!0),B.emit(U.refreshUserInfo)}catch(o){const N=((p=(d=o==null?void 0:o.response)==null?void 0:d.data)==null?void 0:p.message)??"";x.showToast(N.replace(s.email,"").trim())}finally{m(!1)}},y=async()=>{var d,p;if(!(_>0)){if(!R.test(s.email)){s.errors.email=r.email_is_invalid(),v(!0);return}try{await k({authenType:C.EMAIL,authenValue:s.email,otpType:T.ADD});let o=60;f(o),E.current=setInterval(()=>{f(--o),o<=0&&clearInterval(E.current)},1e3)}catch(o){const N=((p=(d=o==null?void 0:o.response)==null?void 0:d.data)==null?void 0:p.message)??"";x.showToast(N.replace(s.email,"").trim())}}};return i.useEffect(()=>()=>{clearInterval(E.current)},[]),i.useEffect(()=>{j()},[s.email,s.otp]),g?e.jsx(V,{title:"Email",className:"max-w-[800px] mx-auto ",children:e.jsx("div",{className:" p-5 pt  overflow-hidden overflow-y-auto hide-scrollbar h-full",children:e.jsx($,{msg:r.email_has_been_bond(),onClick:()=>x.navigate(P.home),title:s.email.substring(0,4)+"***"+s.email.substring(s.email.indexOf("@"))})})}):e.jsx(V,{title:"Email",className:"max-w-[800px] mx-auto ",children:e.jsxs("div",{className:" p-5 pt  overflow-hidden overflow-y-auto hide-scrollbar h-full",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-label",htmlFor:"oldPassword",children:[e.jsx("span",{className:"text-[#ffbc00]",children:"*"})," ",r.email_address()]}),e.jsx("input",{type:"text",name:"email",id:"email",value:s.email,onChange:S,placeholder:r.enter_email_hint(),className:"security w-full rounded-md px-3 h-11 mt-1 bg-[#1b1b1e] outline-none border border-[#333239] placeholder:text-xs placeholder:text-[#393a3e] text-white font-bold"}),w&&s.errors.email&&e.jsx("p",{className:"error",children:s.errors.email})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("label",{className:"text-label ",htmlFor:"confirmPassword",children:[e.jsx("span",{className:"text-[#ffbc00]",children:"*"})," ",r.email_verification_code()]}),e.jsxs("div",{className:"w-full rounded-md px-3 h-11 mt-1 bg-[#1b1b1e] border border-[#333239] flex items-center justify-between",children:[e.jsx("input",{type:"text",id:"otp",name:"otp",value:s.otp,onChange:S,className:"security border-none outline-none grow bg-transparent"}),e.jsx("span",{onClick:y,className:"text-[#fdcd00] underline text-nowrap whitespace-nowrap text-sm",children:_>0?`${r.resend()}(${_})`:r.get_a_verification_code()})]}),w&&s.errors.otp&&e.jsx("p",{className:"error",children:s.errors.otp})]}),e.jsx(G,{title:r.confirm(),onClick:b,className:"mt-9 uppercase",disable:t,useDisableStyle:!O})]})})}const X={newEmail:"",newOtp:"",oldOtp:"",verifyKey:"",errors:{newEmail:"",newOtp:"",oldOtp:""}},Z=(t,m)=>{switch(m.type){case"change":return t.errors[m.field]="",{...t,[m.field]:m.value};default:return t}};function me(){const{userInfo:t}=K(H),[m,w]=i.useState(!1),[v,s]=i.useState(!1),[a,O]=i.useReducer(Z,X),[A,_]=i.useState(!1),[f,g]=i.useState(0),[h,E]=i.useState(1),[S,j]=i.useState(!1),b=i.useRef((t==null?void 0:t.verifyEmail)==0),y=i.useRef(null),d=n=>{const{name:c,value:l}=n.target;s(!1),O({type:"change",field:c,value:l})},p=()=>{a.errors={newEmail:"",newOtp:"",oldOtp:""},h==1?a.oldOtp||(a.errors.oldOtp=r.otp_is_required()):(R.test(a.newEmail)||(a.errors.newEmail=r.email_is_invalid()),a.newEmail==(t==null?void 0:t.email)&&(a.errors.newEmail=r.new_email_must_differ_from_cur()),a.newOtp||(a.errors.newOtp=r.otp_is_required()));const n=!Object.values(a.errors).some(c=>c!="");return _(n),n},o=async()=>{var n,c;if(!p()){s(!0);return}w(!0);try{await W({authenType:C.EMAIL,authenValue:a.newEmail,otp:a.newOtp,verifyKey:a.verifyKey}),j(!0)}catch(l){const u=((c=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:c.message)??"";x.showToast(u.replace(t==null?void 0:t.email,"").replace(a.newEmail,"").trim())}finally{w(!1)}},N=async()=>{var n,c;if(!a.oldOtp){a.errors.oldOtp=r.otp_is_required(),s(!0);return}w(!0);try{await Y({email:(t==null?void 0:t.email)??"",phone:"",otp:a.oldOtp}),j(!0)}catch(l){const u=((c=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:c.message)??"";x.showToast(u.replace((t==null?void 0:t.email)||"","").trim())}finally{w(!1)}},q=async()=>{var n,c;if(!p()){s(!0);return}try{const{verifyKey:l}=await z({authenType:C.EMAIL,authenValue:t==null?void 0:t.email,otp:a.oldOtp});O({type:"change",field:"verifyKey",value:l}),_(!1),g(0),clearInterval(y.current),E(2)}catch(l){const u=((c=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:c.message)??"";x.showToast(u.replace(t==null?void 0:t.email,"").trim())}},F=async()=>{var n,c;if(!(f>0)){if(a.errors={newEmail:"",newOtp:"",oldOtp:""},h==2){if(!R.test(a.newEmail)){a.errors.newEmail=r.email_is_invalid(),s(!0);return}if(a.newEmail==(t==null?void 0:t.email)){a.errors.newEmail=r.new_email_must_differ_from_cur(),s(!0);return}}try{let l=T.VERIFY;b.current||(h==1?l=T.CHANGE_OLD:l=T.CHANGE_NEW),await k({authenType:C.EMAIL,authenValue:h==1?t==null?void 0:t.email:a.newEmail,otpType:l});let u=60;g(u),y.current=setInterval(()=>{g(--u),u<=0&&clearInterval(y.current)},1e3)}catch(l){const u=((c=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:c.message)??"";x.showToast(u.replace(a.newEmail,"").replace((t==null?void 0:t.email)??"","").trim())}}},D=()=>{if(b.current){N();return}if(h==1){q();return}o()};return i.useEffect(()=>()=>{clearInterval(y.current)},[]),i.useEffect(()=>{p()},[a.newEmail,a.newOtp,a.oldOtp]),S?e.jsx(V,{title:"Email",className:"max-w-[800px] mx-auto ",children:e.jsx("div",{className:" p-5 pt  overflow-hidden overflow-y-auto hide-scrollbar h-full",children:e.jsx($,{msg:b.current?r.email_has_been_verified():r.email_has_been_bond(),onClick:()=>x.navigate(P.home),title:L(a.newEmail||(t==null?void 0:t.email))})})}):e.jsx(V,{title:"Email",className:"max-w-[800px] mx-auto ",children:e.jsxs("div",{className:" p-5 pt  overflow-hidden overflow-y-auto hide-scrollbar h-full",children:[h==1&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-md flex flex-col items-center justify-center py-14 bg-[var(--box-bg)]",children:[e.jsx("div",{className:"text-3xl font-semibold",children:L((t==null?void 0:t.email)??"")}),e.jsx("div",{className:"text-[var(--text-content-color)] mt-2",children:r.your_current_email_address()})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("label",{className:"text-label ",htmlFor:"confirmPassword",children:[e.jsx("span",{className:"text-[#ffbc00]",children:"*"})," ",r.email_verification_code()]}),e.jsxs("div",{className:"w-full input-all input-all__border px-3 h-11 mt-1 flex items-center justify-between",children:[e.jsx("input",{type:"text",id:"oldOtp",name:"oldOtp",value:a.oldOtp,onChange:d,className:"security border-none outline-none grow bg-transparent"}),e.jsx("span",{onClick:F,className:"text-[#fdcd00] underline text-nowrap whitespace-nowrap text-sm",children:f>0?`${r.resend()}(${f})`:r.get_a_verification_code()})]}),v&&a.errors.oldOtp&&e.jsx("p",{className:"error",children:a.errors.oldOtp})]})]}),h==2&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-label",htmlFor:"newEmail",children:[e.jsx("span",{className:"text-[#ffbc00]",children:"*"})," ",r.new_email_address()]}),e.jsx("input",{type:"text",name:"newEmail",id:"newEmail",value:a.newEmail,onChange:d,placeholder:r.enter_email_hint(),className:"security w-full input-all input-all__border px-3 h-11 mt-1 font-bold"}),v&&a.errors.newEmail&&e.jsx("p",{className:"error",children:a.errors.newEmail})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("label",{className:"text-label ",children:[e.jsx("span",{className:"text-[#ffbc00]",children:"*"})," ",r.email_verification_code()]}),e.jsxs("div",{className:"w-full input-all input-all__border px-3 h-11 mt-1 flex items-center justify-between",children:[e.jsx("input",{type:"text",id:"newOtp",name:"newOtp",value:a.newOtp,onChange:d,className:"security border-none outline-none grow bg-transparent"}),e.jsx("span",{onClick:F,className:"text-[#fdcd00] underline text-nowrap whitespace-nowrap text-sm",children:f>0?`${r.resend()}(${f})`:r.get_a_verification_code()})]}),v&&a.errors.newOtp&&e.jsx("p",{className:"error",children:a.errors.newOtp})]})]}),e.jsx(G,{title:h==1&&!b.current?r.next_step():r.confirm(),onClick:D,className:"mt-9 uppercase",disable:m,useDisableStyle:!A})]})})}export{ce as AddEmail,me as ChangeEmail};
